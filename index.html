<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>出勤カレンダー（日別日給対応）</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      text-align: center;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      height: 80px;
      vertical-align: top;
    }

    th {
      background-color: #f2f2f2;
    }

    .worked {
      background-color: #c8facc;
    }

    .holiday {
      background-color: #ffe0e0;
    }

    .holiday-label {
      font-size: 0.7em;
      color: #d00;
    }

    .sunday {
      color: red;
    }

    .saturday {
      color: blue;
    }

    .day-wage {
      width: 60px;
      font-size: 0.8em;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>出勤カレンダー（日別日給対応）</h1>
  <label for="month">表示する月:</label>
  <input type="month" id="month" value="2025-07" />
  <br /><br />
  <table id="calendar"></table>
  <br />
  <button onclick="calculate()">給料を計算する</button>
  <p>出勤日数: <span id="workedDays">0</span> 日</p>
  <p>合計給料: <span id="totalSalary">0</span> 円</p>

  <script>
    let holidays = {};

    async function fetchHolidays(year) {
      try {
        const res = await fetch(`https://holidays-jp.github.io/api/v1/${year}/date.json`);
        holidays = await res.json();
      } catch (e) {
        console.error("祝日の取得に失敗しました", e);
        holidays = {};
      }
      generateCalendar();
    }

    function generateCalendar() {
      const table = document.getElementById("calendar");
      const monthInput = document.getElementById("month").value;
      const [year, month] = monthInput.split("-").map(Number);

      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0);
      const startDay = firstDay.getDay();
      const totalDays = lastDay.getDate();

      table.innerHTML = "";

      const headerRow = document.createElement("tr");
      ["日", "月", "火", "水", "木", "金", "土"].forEach(day => {
        const th = document.createElement("th");
        th.textContent = day;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      let row = document.createElement("tr");
      for (let i = 0; i < startDay; i++) {
        row.appendChild(document.createElement("td"));
      }

      for (let day = 1; day <= totalDays; day++) {
        const cell = document.createElement("td");
        const dateStr = `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
        const dateObj = new Date(dateStr);
        const weekday = dateObj.getDay();

        if (weekday === 0) cell.classList.add("sunday");
        if (weekday === 6) cell.classList.add("saturday");

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.date = dateStr;
        checkbox.onclick = updateWorkDays;

        const wageInput = document.createElement("input");
        wageInput.type = "number";
        wageInput.placeholder = "日給";
        wageInput.className = "day-wage";
        wageInput.dataset.date = dateStr;
        wageInput.oninput = calculate;

        cell.innerHTML = `${day}<br>`;
        cell.appendChild(checkbox);
        cell.appendChild(document.createElement("br"));
        cell.appendChild(wageInput);

        if (holidays[dateStr]) {
          cell.classList.add("holiday");
          const label = document.createElement("div");
          label.textContent = holidays[dateStr];
          label.className = "holiday-label";
          cell.appendChild(label);
        }

        row.appendChild(cell);

        if ((startDay + day - 1) % 7 === 6 || day === totalDays) {
          table.appendChild(row);
          row = document.createElement("tr");
        }
      }

      loadData(); 
      updateWorkDays(); 
    }

    function updateWorkDays() {
      const boxes = document.querySelectorAll("input[type='checkbox']");
      let count = 0;
      boxes.forEach(box => {
        if (box.checked) {
          count++;
          box.parentNode.classList.add("worked");
        } else {
          box.parentNode.classList.remove("worked");
        }
      });
      document.getElementById("workedDays").textContent = count;
      calculate();
      saveData(); 
    }

    function calculate() {
      const checkboxes = document.querySelectorAll("input[type='checkbox']");
      let total = 0;

      checkboxes.forEach(checkbox => {
        if (checkbox.checked) {
          const date = checkbox.dataset.date;
          const wageInput = document.querySelector(`input.day-wage[data-date='${date}']`);
          const wage = parseInt(wageInput.value) || 0;
          total += wage;
        }
      });

      document.getElementById("totalSalary").textContent = total.toLocaleString();
      saveData(); 
    }

    function saveData() {
      const data = {};
      const checkboxes = document.querySelectorAll("input[type='checkbox']");
      const wages = document.querySelectorAll("input.day-wage");

      checkboxes.forEach(cb => {
        data[cb.dataset.date] = data[cb.dataset.date] || {};
        data[cb.dataset.date].worked = cb.checked;
      });

      wages.forEach(w => {
        data[w.dataset.date] = data[w.dataset.date] || {};
        data[w.dataset.date].wage = w.value;
      });

      const month = document.getElementById("month").value;
      localStorage.setItem("workCalendar_" + month, JSON.stringify(data));
    }

    function loadData() {
      const month = document.getElementById("month").value;
      const data = JSON.parse(localStorage.getItem("workCalendar_" + month) || "{}");

      Object.entries(data).forEach(([date, info]) => {
        const cb = document.querySelector(`input[type='checkbox'][data-date='${date}']`);
        const wageInput = document.querySelector(`input.day-wage[data-date='${date}']`);
        if (cb) cb.checked = info.worked || false;
        if (wageInput && info.wage !== undefined) wageInput.value = info.wage;
      });
    }

    document.getElementById("month").addEventListener("change", () => {
      const [year] = document.getElementById("month").value.split("-").map(Number);
      fetchHolidays(year);
    });

    window.onload = () => {
      const [year] = document.getElementById("month").value.split("-").map(Number);
      fetchHolidays(year);
    };
  </script>
</body>
</html>
